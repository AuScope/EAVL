/*
 feedback.js <http://experiments.hertzen.com/jsfeedback/>
 Copyright (c) 2012 Niklas von Hertzen. All rights reserved.
 http://www.twitter.com/niklasvh

 Released under MIT License
*/
!function(e,t,a){if(e.Feedback===a){var n,i=function(t){e.console.log(t)},s=function(e){for(var t=[],n=e.length;n--;t.unshift(e[n]));for(var n=0,i=t.length;i>n;n++){var s=Array.prototype.pop.call(t);s!==a&&null!==s.parentNode&&s.parentNode.removeChild(s)}},l=function(){var e=t.createElement("div"),a=3;for(e.className="feedback-loader";a--;)e.appendChild(t.createElement("span"));return e},o=function(e){return e.getBoundingClientRect()},d=function(e){for(var t;null!==(t=e.firstChild)?e.removeChild(t):!1;);},r=function(e,a){var n=t.createElement(e);return n.appendChild(t.createTextNode(a)),n},c=function(t,n){if(t.onload!==a)return n;if(t.onreadystatechange!==a){var s=function(){"loaded"!==t.readyState&&"complete"!==t.readyState?e.setTimeout(s,250):n()};e.setTimeout(s,250)}else i("ERROR: We can't track when script is loaded")},h="data-html2canvas-ignore",p=t.createElement("div");e.Feedback=function(i){i=i||{},i.label=i.label||"Send Feedback",i.header=i.header||"Send Feedback",i.url=i.url||"/",i.adapter=i.adapter||new e.Feedback.XHR(i.url),i.metadata=i.metadata||{},i.buttonCls=i.buttonCls||"",i.nextLabel=i.nextLabel||"Continue",i.reviewLabel=i.reviewLabel||"Review",i.sendLabel=i.sendLabel||"Send",i.closeLabel=i.closeLabel||"Close",i.disabled=i.disabled||!1,i.disabledCallback=i.disabledCallback||null,i.messageSuccess=i.messageSuccess||"Your feedback was sent succesfully.",i.messageError=i.messageError||"There was an error sending your feedback to the server.",i.pages===a&&(i.pages=[new e.Feedback.Form,new e.Feedback.Screenshot(i),new e.Feedback.Review]);var o,c,m,u=t.createElement("div"),b={open:function(){if(i.disabled)return void(i.disabledCallback&&i.disabledCallback());var a=i.pages.length;for(m=0;a>m;m++)i.pages[m]instanceof e.Feedback.Review||i.pages[m].render();var s=r("a","x"),l=t.createElement("div"),g=t.createElement("div");c=t.createElement("div"),t.body.appendChild(u),s.className="feedback-close",s.onclick=b.close,s.href="#",o.disabled=!0,l.appendChild(s),l.appendChild(r("h3",i.header)),l.className="feedback-header",p.className="feedback-body",d(p),m=0,p.appendChild(i.pages[m++].dom),n=r("button",i.nextLabel),n.className="feedback-btn",n.onclick=function(){m>0&&i.pages[m-1].end(c)===!1||(d(p),m===a?b.send(i.adapter):(i.pages[m].start(c,l,g,n),i.pages[m]instanceof e.Feedback.Review&&i.pages[m].render(i.pages),p.appendChild(i.pages[m++].dom),m===a&&(n.firstChild.nodeValue=i.sendLabel),i.pages[m]instanceof e.Feedback.Review&&(n.firstChild.nodeValue=i.reviewLabel)))},g.className="feedback-footer",g.appendChild(n),c.className="feedback-modal",c.setAttribute(h,!0),c.appendChild(l),c.appendChild(p),c.appendChild(g),t.body.appendChild(c)},close:function(){o.disabled=!1,s([c,u]),m>0&&i.pages[m-1].end(c);for(var e=0,t=i.pages.length;t>e;e++)i.pages[e].close();return!1},send:function(a){if(!(a instanceof e.Feedback.Send))throw new Error("Adapter is not an instance of Feedback.Send");var s=i.pages[0].data(),o={issue:s.Issue,email:s.Email,screenshot:i.pages[1].data(),metadata:i.metadata};n.disabled=!0,d(p),p.appendChild(l()),a.send(o,function(e){d(p),n.disabled=!1,n.firstChild.nodeValue=i.closeLabel,n.onclick=function(){return b.close(),!1},p.appendChild(e===!0?t.createTextNode(i.messageSuccess):t.createTextNode(i.messageError))})}};return u.className="feedback-glass",u.style.pointerEvents="none",u.setAttribute(h,!0),i=i||{},o=r("button",i.label),o.className="feedback-btn "+i.buttonCls,o.setAttribute(h,!0),o.onclick=b.open,null!==i.appendTo&&(i.appendTo!==a?i.appendTo:t.body).appendChild(o),b},e.Feedback.Page=function(){},e.Feedback.Page.prototype={render:function(e){this.dom=e},start:function(){},close:function(){},data:function(){return!1},review:function(){return null},end:function(){return!0}},e.Feedback.Send=function(){},e.Feedback.Send.prototype={send:function(){}},e.Feedback.Form=function(e){this.elements=e||[{type:"textarea",name:"Issue",label:"Please describe the issue you are experiencing",required:!1},{type:"checkbox",name:"Email",label:"I'm happy to receive emails about this issue",required:!1}],this.dom=t.createElement("div")},e.Feedback.Form.prototype=new e.Feedback.Page,e.Feedback.Form.prototype.render=function(){var e,a=0,n=this.elements.length;for(d(this.dom);n>a;a++)switch(e=this.elements[a],e.type){case"checkbox":e.element=this.dom.appendChild(r("input")),e.element.setAttribute("type","checkbox"),e.element.setAttribute("checked","true"),e.element.setAttribute("name",e.name),this.dom.appendChild(r("label",e.label+":")),this.dom.appendChild(r("br"));break;case"textarea":this.dom.appendChild(r("label",e.label+":"+(e.required===!0?" *":""))),this.dom.appendChild(e.element=t.createElement("textarea"))}return this},e.Feedback.Form.prototype.end=function(){for(var e,t=0,a=this.elements.length;a>t;t++){if(e=this.elements[t],e.required===!0&&0===e.element.value.length)return e.element.className="feedback-error",!1;e.element.className=""}return!0},e.Feedback.Form.prototype.data=function(){for(var e,t=0,a=this.elements.length,n={};a>t;t++)switch(e=this.elements[t],e.type){case"checkbox":n[e.name]=e.element.checked?!0:!1;break;case"textarea":n[e.name]=e.element.value}return n},e.Feedback.Form.prototype.review=function(e){for(var a,n=0,i=this.elements.length;i>n;n++)switch(a=this.elements[n],a.type){case"checkbox":a.element.checked?(e.appendChild(r("label","Email Contact: Yes")),e.appendChild(t.createElement("br"))):(e.appendChild(r("label","Email Contact: No")),e.appendChild(t.createElement("br")));break;case"textarea":a.element.value.length>0&&(e.appendChild(r("label",a.name+":")),e.appendChild(t.createTextNode(a.element.value)),e.appendChild(t.createElement("br")))}return e.appendChild(t.createElement("hr")),e},e.Feedback.Review=function(){this.dom=t.createElement("div"),this.dom.className="feedback-review"},e.Feedback.Review.prototype=new e.Feedback.Page,e.Feedback.Review.prototype.render=function(e){var t=0,a=e.length;for(d(this.dom);a>t;t++)e[t].review(this.dom);return this},e.Feedback.Screenshot=function(e){this.options=e||{},this.options.blackoutClass=this.options.blackoutClass||"feedback-blackedout",this.options.highlightClass=this.options.highlightClass||"feedback-highlighted",this.h2cDone=!1},e.Feedback.Screenshot.prototype=new e.Feedback.Page,e.Feedback.Screenshot.prototype.end=function(e){e.className=e.className.replace(/feedback\-animate\-toside/,""),t.body.removeEventListener("mousemove",this.mouseMoveEvent,!1),t.body.removeEventListener("click",this.mouseClickEvent,!1),s([this.h2cCanvas]),this.h2cDone=!1},e.Feedback.Screenshot.prototype.close=function(){s([this.blackoutBox,this.highlightContainer,this.highlightBox,this.highlightClose]),s(t.getElementsByClassName(this.options.blackoutClass)),s(t.getElementsByClassName(this.options.highlightClass))},e.Feedback.Screenshot.prototype.start=function(n,i,s,c){if(this.h2cDone){d(this.dom),c.disabled=!1;var h=this,p="feedback-highlight-element",m="data-exclude",u=!0;this.mouseMoveEvent=function(t){if("string"==typeof t.target.className){if(t.target!==f&&(-1!==t.target.className.indexOf(h.options.blackoutClass)||-1!==t.target.className.indexOf(h.options.highlightClass))){var s=parseInt(t.target.style.left,10)+parseInt(t.target.style.width,10);s=Math.max(s,10),s=Math.min(s,e.innerWidth-15);var l=parseInt(t.target.style.top,10);return l=Math.max(l,10),v.style.left=s+"px",v.style.top=l+"px",g=t.target,E(),void(f=a)}if("BODY"===t.target.nodeName||t.target===v||t.target===n||t.target===c||t.target.parentNode===n||t.target.parentNode===i)return E(),void(f=t.target);F(),t.target!==f&&(f=t.target,e.clearTimeout(b),b=e.setTimeout(function(){var t,a=o(f);u===!1?t=C:(t=k,t.width=a.width,t.height=a.height,w.drawImage(h.h2cCanvas,e.pageXOffset+a.left,e.pageYOffset+a.top,a.width,a.height,0,0,a.width,a.height)),t.setAttribute(m,!1),t.style.left=e.pageXOffset+a.left+"px",t.style.top=e.pageYOffset+a.top+"px",t.style.width=a.width+"px",t.style.height=a.height+"px"},100))}},this.mouseClickEvent=function(e){if(e.preventDefault(),e.stopPropagation(),u===!1){if("false"===C.getAttribute(m)){var n=t.createElement("div");n.className=h.options.blackoutClass,n.style.left=C.style.left,n.style.top=C.style.top,n.style.width=C.style.width,n.style.height=C.style.height,t.body.appendChild(n),f=a}}else"false"===k.getAttribute(m)&&(k.className+=" "+h.options.highlightClass,k.className=k.className.replace(/feedback\-highlight\-element/g,""),h.highlightBox=k=t.createElement("canvas"),w=k.getContext("2d"),k.className+=" "+p,t.body.appendChild(k),E(),f=a)},this.highlightClose=r("div","x"),this.blackoutBox=t.createElement("div"),this.highlightBox=t.createElement("canvas"),this.highlightContainer=t.createElement("div");var b,g,f,v=this.highlightClose,k=this.highlightBox,C=this.blackoutBox,y=this.highlightContainer,w=k.getContext("2d"),x=function(e){e.preventDefault(),-1===S.className.indexOf("active")?(S.className+=" active",T.className=T.className.replace(/active/g,"")):(T.className+=" active",S.className=S.className.replace(/active/g,"")),u=!u},E=function(){N(C),N(k),e.clearTimeout(b)},N=function(e){e.style.left="-5px",e.style.top="-5px",e.style.width="0px",e.style.height="0px",e.setAttribute(m,!0)},F=function(){v.style.left="-50px",v.style.top="-50px"},S=r("a","Blackout"),T=r("a","Highlight");n.className+=" feedback-animate-toside",v.id="feedback-highlight-close",v.addEventListener("click",function(){g.parentNode.removeChild(g),F()},!1),t.body.appendChild(v),this.h2cCanvas.className="feedback-canvas",t.body.appendChild(this.h2cCanvas);var R=[T,S];this.dom.appendChild(r("p","Highlight or blackout important information"));for(var B=0;2>B;B++)R[B].className="feedback-btn feedback-btn-small "+(0===B?"active":"feedback-btn-inverse"),R[B].href="#",R[B].onclick=x,this.dom.appendChild(R[B]),this.dom.appendChild(t.createTextNode(" "));y.id="feedback-highlight-container",y.style.width=this.h2cCanvas.width+"px",y.style.height=this.h2cCanvas.height+"px",this.highlightBox.className+=" "+p,this.blackoutBox.id="feedback-blackout-element",t.body.appendChild(this.highlightBox),y.appendChild(this.blackoutBox),t.body.appendChild(y),t.body.addEventListener("mousemove",this.mouseMoveEvent,!1),t.body.addEventListener("click",this.mouseClickEvent,!1)}else{var L=arguments,h=this;c.disabled!==!0&&this.dom.appendChild(l()),c.disabled=!0,e.setTimeout(function(){h.start.apply(h,L)},500)}},e.Feedback.Screenshot.prototype.render=function(){this.dom=t.createElement("div");var n,s=this,l=this.options,o=function(){try{l.onrendered=l.onrendered||function(e){s.h2cCanvas=e,s.h2cDone=!0},e.html2canvas([t.body],l)}catch(a){s.h2cDone=!0,i("Error in html2canvas: "+a.message)}};if(e.html2canvas===a&&n===a){n=t.createElement("script"),n.src=l.h2cPath||"libs/html2canvas.js",n.onerror=function(){i("Failed to load html2canvas library, check that the path is correctly defined")},n.onload=c(n,function(){return e.html2canvas===a?void i("Loaded html2canvas, but library not found"):(e.html2canvas.logging=e.Feedback.debug,void o())});var d=t.getElementsByTagName("script")[0];d.parentNode.insertBefore(n,d)}else o();return this},e.Feedback.Screenshot.prototype.data=function(){if(this.h2cCanvas!==a){var e,n,i=this.h2cCanvas.getContext("2d"),s=5;i.fillStyle="#000",Array.prototype.slice.call(t.getElementsByClassName("feedback-blackedout"),0).forEach(function(e){var t=o(e);i.fillRect(t.left,t.top,t.width,t.height)});var l=Array.prototype.slice.call(t.getElementsByClassName("feedback-highlighted"),0);l.length>0&&(e=t.createElement("canvas"),n=e.getContext("2d"),e.width=this.h2cCanvas.width,e.height=this.h2cCanvas.height,n.drawImage(this.h2cCanvas,0,0),i.fillStyle="#777",i.globalAlpha=.5,i.fillRect(0,0,this.h2cCanvas.width,this.h2cCanvas.height),i.beginPath(),l.forEach(function(e){var t=parseInt(e.style.left,10),a=parseInt(e.style.top,10),n=parseInt(e.style.width,10),l=parseInt(e.style.height,10);i.moveTo(t+s,a),i.lineTo(t+n-s,a),i.quadraticCurveTo(t+n,a,t+n,a+s),i.lineTo(t+n,a+l-s),i.quadraticCurveTo(t+n,a+l,t+n-s,a+l),i.lineTo(t+s,a+l),i.quadraticCurveTo(t,a+l,t,a+l-s),i.lineTo(t,a+s),i.quadraticCurveTo(t,a,t+s,a)}),i.closePath(),i.clip(),i.globalAlpha=1,i.drawImage(e,0,0));try{return this.h2cCanvas.toDataURL()}catch(d){}}},e.Feedback.Screenshot.prototype.review=function(e){var t=this.data();if(t!==a){var n=new Image;n.src=t,n.style.width="300px",e.appendChild(n)}},e.Feedback.XHR=function(e){this.xhr=new XMLHttpRequest,this.url=e},e.Feedback.XHR.prototype=new e.Feedback.Send,e.Feedback.XHR.prototype.send=function(t,a){var n=this.xhr;n.onreadystatechange=function(){4==n.readyState&&a(200===n.status)},n.open("POST",this.url,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.send("issue="+encodeURIComponent(t.issue)+"&email="+encodeURIComponent(t.email)+"&screenshot="+encodeURIComponent(t.screenshot)+"&metadata="+encodeURIComponent(e.JSON.stringify(t.metadata)))}}}(window,document);
